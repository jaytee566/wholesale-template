---
import { getMarketConfig } from '@/utils/market-config';
import { defaults } from '@/config/defaults';

interface Props {
  headline?: string;
  subtitle?: string;
}

const config = getMarketConfig();
const f = defaults.form;
const { headline, subtitle } = Astro.props;
---

<section class="py-16 bg-green-light border-y border-green/10" id="lead-form">
  <div class="wrap">
    <div class="text-center mb-8">
      <h2 class="font-(family-name:--font-headline) font-extrabold uppercase text-dark mb-2" style="font-size: clamp(24px, 3.5vw, 38px);">
        {headline || f.title}
      </h2>
      <p class="text-gray-500">{subtitle || f.subtitle}</p>
    </div>

    <div class="max-w-[440px] mx-auto">
      <div class="bg-white rounded-[14px] shadow-[0_20px_60px_rgba(0,0,0,0.08),0_0_0_1px_rgba(0,0,0,0.04)] overflow-hidden" id="formCard">
        <!-- Progress bar -->
        <div class="h-[3px] bg-gray-100">
          <div class="h-full rounded-r bg-gradient-to-r from-green to-emerald-400 transition-all duration-400" id="progressFill" style="width: 25%"></div>
        </div>

        <div class="py-6 px-6">
          <div class="flex justify-between items-center mb-1">
            <h3 class="font-(family-name:--font-headline) font-bold text-xl uppercase text-dark">{f.title}</h3>
            <span class="text-[11px] text-gray-400 flex items-center gap-1">&#9201; {f.timer_text}</span>
          </div>
          <p class="text-[13px] text-gray-400 mb-3.5">{f.subtitle}</p>

          <!-- Step 0: Address -->
          <div class="form-step" data-step="0">
            <p class="text-[11px] font-semibold text-gray-400 uppercase tracking-[1px] mb-3.5">Step 1 of 4</p>
            <h4 class="text-lg font-bold text-dark mb-1">What's the property address?</h4>
            <p class="text-[13px] text-gray-500 mb-3.5 leading-relaxed">{f.address_helper}</p>
            <input
              type="text"
              id="addressInput"
              placeholder={`${f.address_placeholder.replace('address', `${config.city} address`)}`}
              autocomplete="off"
              class="w-full py-3 px-3.5 border-2 border-gray-200 rounded-lg text-[15px] bg-white outline-none transition-all focus:border-emerald-400 focus:shadow-[0_0_0_3px_rgba(16,185,129,0.1)]"
            />
            <div class="flex justify-between items-center mt-4">
              <span></span>
              <button class="form-next-btn font-(family-name:--font-headline) font-bold text-[15px] uppercase tracking-wide py-3 px-7 rounded-lg border-none cursor-pointer bg-gradient-to-br from-amber to-amber-light text-white shadow-[0_3px_12px_var(--color-amber-glow)] transition-all duration-200 hover:translate-y-[-1px] hover:shadow-[0_5px_20px_var(--color-amber-glow)] disabled:opacity-35 disabled:cursor-default disabled:shadow-none disabled:hover:translate-y-0" disabled data-next="1">
                Continue &rarr;
              </button>
            </div>
          </div>

          <!-- Step 1: Situation -->
          <div class="form-step hidden" data-step="1">
            <p class="text-[11px] font-semibold text-gray-400 uppercase tracking-[1px] mb-3.5">Step 2 of 4</p>
            <h4 class="text-lg font-bold text-dark mb-1">{f.situation_question}</h4>
            <p class="text-[13px] text-gray-500 mb-3.5 leading-relaxed">{f.situation_helper}</p>
            <div class="grid grid-cols-2 gap-[7px]" id="sitGrid">
              {f.situation_options.map((opt) => (
                <button class="opt-btn py-3 px-3 border-2 border-gray-200 rounded-lg bg-white text-[13px] font-medium text-gray-800 cursor-pointer text-left transition-all hover:border-emerald-400 hover:bg-green-bg">
                  {opt}
                </button>
              ))}
            </div>
            <div class="flex justify-between items-center mt-4">
              <button class="form-back-btn text-[13px] text-gray-400 cursor-pointer bg-transparent border-none hover:text-gray-600" data-back="0">&larr; Back</button>
              <span></span>
            </div>
          </div>

          <!-- Step 2: Timeline -->
          <div class="form-step hidden" data-step="2">
            <p class="text-[11px] font-semibold text-gray-400 uppercase tracking-[1px] mb-3.5">Step 3 of 4</p>
            <h4 class="text-lg font-bold text-dark mb-1">{f.timeline_question}</h4>
            <p class="text-[13px] text-gray-500 mb-3.5 leading-relaxed">{f.timeline_helper}</p>
            <div class="flex flex-col gap-[7px]" id="tlStack">
              {f.timeline_options.map((opt) => (
                <button class:list={[
                  'opt-btn py-3 px-3 border-2 rounded-lg bg-white text-[13px] font-medium text-gray-800 cursor-pointer text-left transition-all',
                  opt.hot ? 'border-amber-light bg-amber-bg hover:border-amber' : 'border-gray-200 hover:border-emerald-400 hover:bg-green-bg'
                ]} data-hot={opt.hot ? 'true' : undefined}>
                  {opt.label}
                </button>
              ))}
            </div>
            <div class="flex justify-between items-center mt-4">
              <button class="form-back-btn text-[13px] text-gray-400 cursor-pointer bg-transparent border-none hover:text-gray-600" data-back="1">&larr; Back</button>
              <span></span>
            </div>
          </div>

          <!-- Step 3: Contact -->
          <div class="form-step hidden" data-step="3">
            <p class="text-[11px] font-semibold text-gray-400 uppercase tracking-[1px] mb-3.5">Step 4 of 4</p>
            <h4 class="text-lg font-bold text-dark mb-1">Where can we <em>discreetly</em> reach you?</h4>
            <p class="text-[13px] text-gray-500 mb-3.5 leading-relaxed">{f.contact_helper}</p>

            <div class="mt-2.5">
              <label class="block text-xs font-semibold text-gray-500 mb-1 uppercase tracking-[0.5px]" for="phoneInput">Phone</label>
              <input type="tel" id="phoneInput" placeholder="(555) 123-4567" class="w-full py-3 px-3.5 border-2 border-gray-200 rounded-lg text-[15px] bg-white outline-none transition-all focus:border-emerald-400 focus:shadow-[0_0_0_3px_rgba(16,185,129,0.1)]" />
              <p class="text-[11px] text-gray-400 mt-1">We'll text or call with your offer — nothing else.</p>
            </div>
            <div class="mt-2.5">
              <label class="block text-xs font-semibold text-gray-500 mb-1 uppercase tracking-[0.5px]" for="nameInput">Name</label>
              <input type="text" id="nameInput" placeholder="First and last" class="w-full py-3 px-3.5 border-2 border-gray-200 rounded-lg text-[15px] bg-white outline-none transition-all focus:border-emerald-400 focus:shadow-[0_0_0_3px_rgba(16,185,129,0.1)]" />
            </div>
            <div class="mt-2.5">
              <label class="block text-xs font-semibold text-gray-500 mb-1 uppercase tracking-[0.5px]" for="emailInput">
                Email <span class="font-normal text-gray-400">(optional)</span>
              </label>
              <input type="email" id="emailInput" placeholder="you@email.com" class="w-full py-3 px-3.5 border-2 border-gray-200 rounded-lg text-[15px] bg-white outline-none transition-all opacity-70 focus:opacity-100 focus:border-emerald-400 focus:shadow-[0_0_0_3px_rgba(16,185,129,0.1)]" />
            </div>

            <!-- SMS Consent — UNCHECKED by default (FCC One-to-One Consent Rule) -->
            <div class="flex items-start gap-2 mt-2.5 text-[10.5px] text-gray-400 leading-relaxed">
              <input type="checkbox" id="smsConsent" class="mt-0.5 shrink-0 accent-green" />
              <label for="smsConsent" class="text-[10.5px] text-gray-400 font-normal normal-case tracking-normal cursor-pointer">
                {f.sms_consent_text.replace('my property', `my property from ${config.company.name}`)}
              </label>
            </div>

            <button
              id="submitBtn"
              disabled
              class="w-full py-[15px] mt-3.5 font-(family-name:--font-headline) font-extrabold text-lg uppercase tracking-wide rounded-lg border-none cursor-pointer bg-gradient-to-br from-amber to-amber-light text-white shadow-[0_4px_16px_var(--color-amber-glow)] transition-all duration-200 hover:translate-y-[-1px] hover:shadow-[0_6px_24px_var(--color-amber-glow)] disabled:opacity-35 disabled:cursor-default disabled:shadow-none disabled:hover:translate-y-0 enabled:animate-[breathe_2.5s_ease-in-out_infinite]"
            >
              {f.submit_text} &rarr;
            </button>
            <p class="text-[11px] text-gray-400 text-center mt-2">&#128274; Encrypted. Never sold to third parties.</p>

            <div class="flex justify-between items-center mt-4">
              <button class="form-back-btn text-[13px] text-gray-400 cursor-pointer bg-transparent border-none hover:text-gray-600" data-back="2">&larr; Back</button>
              <span></span>
            </div>
          </div>
        </div>

        <!-- Point-of-action trust -->
        <div class="bg-gray-50 border-t border-gray-100 py-2.5 px-6 text-center text-xs text-gray-500">
          &#9733; Join <strong class="text-gray-700">{config.market_data.homes_purchased}</strong> {config.city} homeowners who got their fair cash offer
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  let currentStep = 0;
  const formData: Record<string, string | boolean> = { address: '', situation: '', timeline: '', phone: '', name: '', email: '', smsConsent: false };

  function goToStep(n: number) {
    document.querySelectorAll('.form-step').forEach((el) => {
      el.classList.add('hidden');
    });
    const target = document.querySelector(`.form-step[data-step="${n}"]`);
    if (target) {
      target.classList.remove('hidden');
      (target as HTMLElement).style.animation = 'slideIn 0.25s ease';
    }
    currentStep = n;
    const fill = document.getElementById('progressFill');
    if (fill) fill.style.width = `${(n + 1) * 25}%`;

    const firstInput = target?.querySelector<HTMLInputElement>('input[type="text"], input[type="tel"]');
    if (firstInput) setTimeout(() => firstInput.focus(), 100);
  }

  // Step 0: Address
  const addressInput = document.getElementById('addressInput') as HTMLInputElement;
  const nextBtns = document.querySelectorAll<HTMLButtonElement>('.form-next-btn');
  if (addressInput) {
    addressInput.addEventListener('input', () => {
      formData.address = addressInput.value;
      nextBtns.forEach((btn) => {
        if (btn.dataset.next === '1') btn.disabled = addressInput.value.length < 6;
      });
    });
    addressInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && addressInput.value.length >= 6) goToStep(1);
    });
  }

  // Next/Back buttons
  nextBtns.forEach((btn) => {
    btn.addEventListener('click', () => {
      const next = parseInt(btn.dataset.next || '0');
      goToStep(next);
    });
  });
  document.querySelectorAll<HTMLButtonElement>('.form-back-btn').forEach((btn) => {
    btn.addEventListener('click', () => {
      const back = parseInt(btn.dataset.back || '0');
      goToStep(back);
    });
  });

  // Step 1: Situation (auto-advance)
  document.querySelectorAll('#sitGrid .opt-btn').forEach((btn) => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('#sitGrid .opt-btn').forEach((b) => {
        b.classList.remove('!border-green', '!bg-green-bg', '!text-green', '!font-semibold');
      });
      btn.classList.add('!border-green', '!bg-green-bg', '!text-green', '!font-semibold');
      formData.situation = btn.textContent?.trim() || '';
      setTimeout(() => goToStep(2), 280);
    });
  });

  // Step 2: Timeline (auto-advance)
  document.querySelectorAll('#tlStack .opt-btn').forEach((btn) => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('#tlStack .opt-btn').forEach((b) => {
        b.classList.remove('!border-green', '!bg-green-bg', '!text-green', '!font-semibold', '!border-amber', '!bg-amber-bg', '!text-amber');
      });
      if (btn.getAttribute('data-hot') === 'true') {
        btn.classList.add('!border-amber', '!bg-amber-bg', '!text-amber', '!font-semibold');
      } else {
        btn.classList.add('!border-green', '!bg-green-bg', '!text-green', '!font-semibold');
      }
      formData.timeline = btn.textContent?.trim() || '';
      setTimeout(() => goToStep(3), 280);
    });
  });

  // Step 3: Contact validation
  const phoneInput = document.getElementById('phoneInput') as HTMLInputElement;
  const nameInput = document.getElementById('nameInput') as HTMLInputElement;
  const submitBtn = document.getElementById('submitBtn') as HTMLButtonElement;

  function checkContact() {
    if (submitBtn && phoneInput) {
      submitBtn.disabled = phoneInput.value.length < 7;
    }
  }
  phoneInput?.addEventListener('input', checkContact);
  nameInput?.addEventListener('input', checkContact);

  // Submit — redirect to thank-you page
  submitBtn?.addEventListener('click', () => {
    formData.phone = phoneInput?.value || '';
    formData.name = nameInput?.value || '';
    formData.email = (document.getElementById('emailInput') as HTMLInputElement)?.value || '';
    formData.smsConsent = (document.getElementById('smsConsent') as HTMLInputElement)?.checked || false;

    const payload = {
      ...formData,
      consent_timestamp: new Date().toISOString(),
      page_url: window.location.href,
      utm_params: Object.fromEntries(new URLSearchParams(window.location.search)),
    };

    // TODO: POST to Cloudflare Worker endpoint
    console.log('LEAD:', JSON.stringify(payload));

    window.location.href = '/thank-you';
  });
</script>
