---
import { getMarketConfig } from '@/utils/market-config';
import { defaults } from '@/config/defaults';

const config = getMarketConfig();
const faqDefaults = defaults.faq;

// Build FAQ schema
const faqSchema = {
  '@context': 'https://schema.org',
  '@type': 'FAQPage',
  mainEntity: config.faq.map((item) => ({
    '@type': 'Question',
    name: item.question,
    acceptedAnswer: { '@type': 'Answer', text: item.answer },
  })),
};
---

<section class="py-20 bg-gray-50" id="faq">
  <div class="wrap">
    <span class="font-(family-name:--font-headline) font-bold text-[13px] uppercase tracking-[0.12em] text-green mb-3 inline-block">{faqDefaults.tag}</span>
    <h2 class="font-(family-name:--font-headline) font-extrabold uppercase leading-[1.08] text-dark mb-4" style="font-size: clamp(26px, 3.5vw, 38px);">
      {faqDefaults.title}
    </h2>

    <div class="mt-8 max-w-[680px]">
      {config.faq.map((item, i) => (
        <div class="faq-item border-b border-gray-100">
          <button class="faq-q w-full bg-transparent border-none cursor-pointer flex justify-between items-center py-4 text-[15px] font-semibold text-gray-800 text-left hover:text-green transition-colors">
            {item.question}
            <span class="faq-icon text-lg text-gray-400 transition-transform duration-200 shrink-0 ml-3">+</span>
          </button>
          <div class:list={['faq-a overflow-hidden transition-[max-height] duration-300', i > 0 && 'max-h-0']}>
            <p class="pb-4 text-sm text-gray-500 leading-relaxed pr-12">{item.answer}</p>
          </div>
        </div>
      ))}
    </div>
  </div>

  <script type="application/ld+json" set:html={JSON.stringify(faqSchema)} />
</section>

<script>
  document.querySelectorAll('.faq-q').forEach((btn, index) => {
    // Auto-open first item on page load
    if (index === 0) {
      btn.classList.add('active');
      const icon = btn.querySelector('.faq-icon') as HTMLElement;
      if (icon) icon.style.transform = 'rotate(45deg)';
      const answer = btn.nextElementSibling as HTMLElement;
      if (answer) answer.style.maxHeight = answer.scrollHeight + 'px';
    }

    btn.addEventListener('click', () => {
      const answer = btn.nextElementSibling as HTMLElement;
      const icon = btn.querySelector('.faq-icon') as HTMLElement;
      const isOpen = btn.classList.contains('active');

      // Close all
      document.querySelectorAll('.faq-q').forEach((b) => {
        b.classList.remove('active');
        const a = b.nextElementSibling as HTMLElement;
        const ic = b.querySelector('.faq-icon') as HTMLElement;
        if (a) a.style.maxHeight = '';
        if (ic) ic.style.transform = '';
      });

      // Open this one if it wasn't open
      if (!isOpen && answer) {
        btn.classList.add('active');
        answer.style.maxHeight = answer.scrollHeight + 'px';
        if (icon) icon.style.transform = 'rotate(45deg)';
      }
    });
  });
</script>
