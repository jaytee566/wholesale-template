---
import BaseLayout from '@/layouts/BaseLayout.astro';
import Header from '@/components/layout/Header.astro';
import Footer from '@/components/layout/Footer.astro';
import Breadcrumb from '@/components/ui/Breadcrumb.astro';
import FinalCTA from '@/components/sections/FinalCTA.astro';
import { getMarketConfig } from '@/utils/market-config';
import { defaults } from '@/config/defaults';
import { buildBreadcrumbSchema, replaceTokens } from '@/utils/seo';

export function getStaticPaths() {
  const config = getMarketConfig();
  return config.situations.map((s) => ({ params: { slug: s.slug } }));
}

const config = getMarketConfig();
const r = (t: string) => replaceTokens(t, config);

const { slug } = Astro.params;
const situation = config.situations.find((s) => s.slug === slug);
if (!situation) {
  return Astro.redirect('/404');
}

const pageDefaults = defaults.situation_pages[situation.slug];

const title = r(pageDefaults?.title_tag_template ?? `${situation.title} in {city} | {company}`);
const description = r(pageDefaults?.meta_description_template ?? situation.short_desc);

const breadcrumbSchema = buildBreadcrumbSchema(config.domain, [
  { name: 'Home', url: '/' },
  { name: situation.title, url: `/situations/${situation.slug}` },
]);

const serviceSchema = {
  '@context': 'https://schema.org',
  '@type': 'Service',
  name: `${situation.title} - Cash Home Buyers`,
  description: situation.short_desc,
  provider: {
    '@type': 'RealEstateAgent',
    name: config.company.name,
    telephone: `+1${config.company.phone_raw}`,
  },
  areaServed: {
    '@type': 'City',
    name: config.city,
  },
};
---

<BaseLayout title={title} description={description} canonicalPath={`/situations/${situation.slug}`} jsonLd={[breadcrumbSchema, serviceSchema]}>
  <Header solid />
  <Breadcrumb items={[{ label: 'Home', href: '/' }]} current={situation.title} />

  <main>
    <!-- Page header -->
    <section class="pb-8">
      <div class="wrap">
        <span class="font-(family-name:--font-headline) font-bold text-[13px] uppercase tracking-[0.12em] text-green mb-3 inline-block">{defaults.situations.tag}</span>
        <h1 class="font-(family-name:--font-headline) font-extrabold uppercase leading-[1.08] text-dark mb-5" style="font-size: clamp(28px, 4.5vw, 48px);">
          {situation.hero_headline}
        </h1>
        <p class="text-[17px] text-gray-500 leading-relaxed max-w-[640px]">
          {situation.short_desc}
        </p>
      </div>
    </section>

    <!-- Content section (from defaults) -->
    {pageDefaults?.content && (
      <section class="py-12">
        <div class="wrap max-w-[700px] prose-content" set:html={r(pageDefaults.content)} />
      </section>
    )}

    <!-- How it works summary -->
    <section class="py-14 bg-gray-50 border-y border-gray-100">
      <div class="wrap max-w-[700px] reveal">
        <h2 class="font-(family-name:--font-headline) font-extrabold uppercase leading-[1.08] text-dark mb-6" style="font-size: clamp(22px, 3vw, 32px);">
          {defaults.how_it_works.title}
        </h2>
        {defaults.how_it_works.steps.map((step, i) => (
          <div class:list={['flex items-start gap-4 mb-6 last:mb-0', i > 0 && `reveal-d${Math.min(i, 3)}`]}>
            <span class="w-10 h-10 rounded-full bg-green text-white flex items-center justify-center font-(family-name:--font-headline) font-bold text-sm shrink-0">
              {i + 1}
            </span>
            <div>
              <h3 class="font-(family-name:--font-headline) font-bold text-[16px] uppercase mb-0.5">{step.title}</h3>
              <p class="text-[14px] text-gray-500 leading-relaxed">{step.description}</p>
            </div>
          </div>
        ))}
      </div>
    </section>

    <!-- CTA section -->
    <section class="py-14 bg-green-light border-y border-green/10">
      <div class="wrap text-center reveal">
        <h2 class="font-(family-name:--font-headline) font-extrabold uppercase text-dark mb-3" style="font-size: clamp(22px, 3.5vw, 36px);">
          {defaults.mid_cta.headline}
        </h2>
        <p class="text-gray-500 mb-7">{defaults.mid_cta.sub_text}</p>
        <div class="flex justify-center flex-wrap gap-3">
          <a
            href="/#lead-form"
            class="inline-block font-(family-name:--font-headline) font-bold text-[17px] uppercase tracking-wide py-[15px] px-9 rounded-lg bg-gradient-to-br from-amber to-amber-light text-white shadow-[0_4px_16px_var(--color-amber-glow)] transition-all duration-200 hover:translate-y-[-1px] hover:shadow-[0_6px_24px_var(--color-amber-glow)]"
          >
            {defaults.mid_cta.button_text}
          </a>
          <a
            href={`tel:${config.company.phone_raw}`}
            class="inline-flex items-center gap-2 py-[15px] px-7 text-base font-semibold text-dark border-2 border-gray-200 rounded-lg transition-all duration-200 hover:border-green hover:text-green"
          >
            Call {config.company.phone}
          </a>
        </div>
      </div>
    </section>

    <!-- Internal links -->
    <section class="py-12">
      <div class="wrap text-center text-[15px] text-gray-500 space-x-4">
        <a href="/how-it-works" class="text-green font-semibold underline hover:text-green-dark transition-colors">See our process</a>
        <span class="text-gray-300">|</span>
        <a href="/about" class="text-green font-semibold underline hover:text-green-dark transition-colors">About us</a>
        {config.situations.filter((s) => s.slug !== situation.slug).slice(0, 2).map((s) => (
          <><span class="text-gray-300">|</span><a href={`/situations/${s.slug}`} class="text-green font-semibold underline hover:text-green-dark transition-colors">{s.title}</a></>
        ))}
      </div>
    </section>
  </main>

  <FinalCTA />
  <Footer />
</BaseLayout>
