---
import BaseLayout from '@/layouts/BaseLayout.astro';
import Header from '@/components/layout/Header.astro';
import Footer from '@/components/layout/Footer.astro';
import Breadcrumb from '@/components/ui/Breadcrumb.astro';
import FormSection from '@/components/sections/FormSection.astro';
import FinalCTA from '@/components/sections/FinalCTA.astro';
import { getMarketConfig } from '@/utils/market-config';
import { defaults } from '@/config/defaults';
import { buildBreadcrumbSchema, buildServiceSchema, buildFAQPageSchema, replaceTokens } from '@/utils/seo';

export function getStaticPaths() {
  const config = getMarketConfig();
  return config.neighborhoods.map((n) => ({ params: { slug: n.slug } }));
}

const config = getMarketConfig();
const r = (t: string) => replaceTokens(t, config);

const { slug } = Astro.params;
const neighborhood = config.neighborhoods.find((n) => n.slug === slug);
if (!neighborhood) {
  return Astro.redirect('/404');
}

const pageDefaults = defaults.area_pages[neighborhood.slug];

const title = r(pageDefaults?.title_tag_template ?? `Sell Your House Fast in ${neighborhood.name}, {city} | {company}`);
const description = r(pageDefaults?.meta_description_template ?? neighborhood.description);
const h1 = pageDefaults?.h1_template ?? `Sell Your ${neighborhood.name} Home Fast for Cash`;

const breadcrumbSchema = buildBreadcrumbSchema(config.domain, [
  { name: 'Home', url: '/' },
  { name: neighborhood.name, url: `/areas/${neighborhood.slug}` },
]);

const serviceSchema = buildServiceSchema(
  config,
  `Cash Home Buyers in ${neighborhood.name}, ${config.city}`,
  neighborhood.description,
  `https://${config.domain}/areas/${neighborhood.slug}`,
);

const faqItems = pageDefaults?.faq || [];
const schemas: Record<string, unknown>[] = [breadcrumbSchema, serviceSchema];
if (faqItems.length > 0) {
  schemas.push(buildFAQPageSchema(faqItems));
}

// Internal links: How It Works + About Us + 2–3 situation pages
const linkedSituations = config.situations.slice(0, 3);
---

<BaseLayout title={title} description={description} canonicalPath={`/areas/${neighborhood.slug}`} jsonLd={schemas}>
  <Header solid />
  <Breadcrumb items={[{ label: 'Home', href: '/' }]} current={neighborhood.name} />

  <main>
    <!-- Page header -->
    <section class="pb-8">
      <div class="wrap">
        <span class="font-(family-name:--font-headline) font-bold text-[13px] uppercase tracking-[0.12em] text-green mb-3 inline-block">Service Area</span>
        <h1 class="font-(family-name:--font-headline) font-extrabold uppercase leading-[1.08] text-dark mb-5" style="font-size: clamp(28px, 4.5vw, 48px);">
          {h1}
        </h1>
        <p class="text-[17px] text-gray-500 leading-relaxed max-w-[640px]">
          {neighborhood.description}
        </p>
      </div>
    </section>

    <!-- Content section -->
    {pageDefaults?.content && (
      <section class="py-12">
        <div class="wrap max-w-[700px] prose-content" set:html={r(pageDefaults.content)} />
      </section>
    )}

    <!-- Form Section -->
    <FormSection headline={`Get Your ${neighborhood.name} Cash Offer`} subtitle={`No obligation. Takes 60 seconds. We buy homes in ${neighborhood.name} as-is.`} />

    <!-- Testimonial -->
    {config.testimonials[0] && (
      <section class="py-14 bg-gray-50 border-y border-gray-100">
        <div class="wrap max-w-[600px] reveal">
          <div class="flex items-center gap-[2px] mb-3">
            {[1,2,3,4,5].map(() => (
              <svg width="18" height="18" viewBox="0 0 24 24" fill="#FBBC04" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
              </svg>
            ))}
          </div>
          <blockquote class="text-[16px] text-gray-700 leading-relaxed italic mb-4">"{config.testimonials[0].outcome}"</blockquote>
          <cite class="text-sm text-gray-500 not-italic block">
            — {config.testimonials[0].name}, {config.testimonials[0].location} · Closed in {config.testimonials[0].timeframe}
          </cite>
        </div>
      </section>
    )}

    <!-- FAQ accordion -->
    {faqItems.length > 0 && (
      <section class="py-16" id="faq">
        <div class="wrap">
          <h2 class="font-(family-name:--font-headline) font-extrabold uppercase leading-[1.08] text-dark mb-6" style="font-size: clamp(22px, 3vw, 32px);">
            Common Questions About Selling in {neighborhood.name}
          </h2>
          <div class="max-w-[680px]">
            {faqItems.map((item, i) => (
              <div class="area-faq-item border-b border-gray-100">
                <button class="area-faq-q w-full bg-transparent border-none cursor-pointer flex justify-between items-center py-4 text-[15px] font-semibold text-gray-800 text-left hover:text-green transition-colors">
                  {item.question}
                  <span class="area-faq-icon text-lg text-gray-400 transition-transform duration-200 shrink-0 ml-3">+</span>
                </button>
                <div class:list={['area-faq-a overflow-hidden transition-[max-height] duration-300', i === 0 ? '' : 'max-h-0']}>
                  <p class="pb-4 text-sm text-gray-500 leading-relaxed pr-12">{item.answer}</p>
                </div>
              </div>
            ))}
          </div>
        </div>
      </section>
    )}

    <!-- Internal links -->
    <section class="py-12">
      <div class="wrap">
        <h3 class="font-(family-name:--font-headline) font-bold text-[15px] uppercase text-gray-400 tracking-[0.08em] mb-4">Related Pages</h3>
        <div class="flex flex-wrap gap-x-5 gap-y-2 text-[15px]">
          <a href="/how-it-works" class="text-green font-semibold underline hover:text-green-dark transition-colors">How It Works</a>
          <a href="/about" class="text-green font-semibold underline hover:text-green-dark transition-colors">About Us</a>
          {linkedSituations.map((s) => (
            <a href={`/situations/${s.slug}`} class="text-green font-semibold underline hover:text-green-dark transition-colors">{s.title}</a>
          ))}
        </div>
      </div>
    </section>
  </main>

  <FinalCTA />
  <Footer />
</BaseLayout>

<script>
  // Area page FAQ accordion
  document.querySelectorAll('.area-faq-q').forEach((btn, index) => {
    // Open first item by default
    if (index === 0) {
      btn.classList.add('active');
      const icon = btn.querySelector('.area-faq-icon') as HTMLElement;
      if (icon) icon.style.transform = 'rotate(45deg)';
      const answer = btn.nextElementSibling as HTMLElement;
      if (answer) answer.style.maxHeight = answer.scrollHeight + 'px';
    }

    btn.addEventListener('click', () => {
      const answer = btn.nextElementSibling as HTMLElement;
      const icon = btn.querySelector('.area-faq-icon') as HTMLElement;
      const isOpen = btn.classList.contains('active');

      // Close all
      document.querySelectorAll('.area-faq-q').forEach((b) => {
        b.classList.remove('active');
        const a = b.nextElementSibling as HTMLElement;
        const ic = b.querySelector('.area-faq-icon') as HTMLElement;
        if (a) a.style.maxHeight = '';
        if (ic) ic.style.transform = '';
      });

      // Open this one if it wasn't open
      if (!isOpen && answer) {
        btn.classList.add('active');
        answer.style.maxHeight = answer.scrollHeight + 'px';
        if (icon) icon.style.transform = 'rotate(45deg)';
      }
    });
  });
</script>
