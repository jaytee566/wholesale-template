---
import BaseLayout from '@/layouts/BaseLayout.astro';
import Header from '@/components/layout/Header.astro';
import Footer from '@/components/layout/Footer.astro';
import Breadcrumb from '@/components/ui/Breadcrumb.astro';
import FinalCTA from '@/components/sections/FinalCTA.astro';
import { getMarketConfig } from '@/utils/market-config';
import { defaults } from '@/config/defaults';
import { buildBreadcrumbSchema, replaceTokens } from '@/utils/seo';

export function getStaticPaths() {
  return defaults.blog_posts.map((post) => ({ params: { slug: post.slug } }));
}

const config = getMarketConfig();
const r = (t: string) => replaceTokens(t, config);

const { slug } = Astro.params;
const post = defaults.blog_posts.find((p) => p.slug === slug);
if (!post) {
  return Astro.redirect('/404');
}

const title = r(`${post.title} | {company}`);
const description = r(post.excerpt);
const canonicalPath = `/blog/${post.slug}`;

const breadcrumbSchema = buildBreadcrumbSchema(config.domain, [
  { name: 'Home', url: '/' },
  { name: 'Blog', url: '/blog' },
  { name: post.title, url: canonicalPath },
]);

const articleSchema = {
  '@context': 'https://schema.org',
  '@type': 'Article',
  headline: post.title,
  description: post.excerpt,
  datePublished: post.date,
  author: {
    '@type': 'Person',
    name: post.author,
  },
  publisher: {
    '@type': 'Organization',
    name: config.company.name,
    url: `https://${config.domain}`,
  },
  mainEntityOfPage: `https://${config.domain}${canonicalPath}`,
};

function formatDate(dateStr: string): string {
  const d = new Date(dateStr + 'T00:00:00');
  return d.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
}

// Related links: 2–3 situation pages + form
const linkedSituations = config.situations.slice(0, 3);
const otherPosts = defaults.blog_posts.filter((p) => p.slug !== post.slug).slice(0, 2);
---

<BaseLayout title={title} description={description} canonicalPath={canonicalPath} jsonLd={[breadcrumbSchema, articleSchema]}>
  <Header solid />
  <Breadcrumb items={[{ label: 'Home', href: '/' }, { label: 'Blog', href: '/blog' }]} current={post.title} />

  <main>
    <!-- Article header -->
    <section class="pb-6">
      <div class="wrap max-w-[740px]">
        <div class="flex items-center gap-3 mb-4">
          {post.tags.map((tag) => (
            <span class="text-[11px] font-semibold text-green bg-green-bg py-0.5 px-2.5 rounded-full uppercase tracking-wide">{tag.replace('-', ' ')}</span>
          ))}
        </div>
        <h1 class="font-(family-name:--font-headline) font-extrabold uppercase leading-[1.08] text-dark mb-5" style="font-size: clamp(26px, 4vw, 44px);">
          {post.title}
        </h1>
        <div class="flex items-center gap-3 text-sm text-gray-400">
          <div class="w-8 h-8 rounded-full bg-gray-600 text-white flex items-center justify-center text-xs font-bold shrink-0">
            {post.author.charAt(0).toUpperCase()}
          </div>
          <span class="font-medium text-gray-600">{post.author}</span>
          <span class="text-gray-300">·</span>
          <time datetime={post.date}>{formatDate(post.date)}</time>
        </div>
      </div>
    </section>

    <!-- Article content -->
    <section class="py-10">
      <div class="wrap max-w-[740px] prose-content" set:html={r(post.content)} />
    </section>

    <!-- Mid-article CTA -->
    <section class="py-12 bg-green-light border-y border-green/10">
      <div class="wrap text-center reveal">
        <h2 class="font-(family-name:--font-headline) font-extrabold uppercase text-dark mb-3" style="font-size: clamp(22px, 3vw, 34px);">
          {defaults.mid_cta.headline}
        </h2>
        <p class="text-gray-500 mb-6">{defaults.mid_cta.sub_text}</p>
        <div class="flex justify-center flex-wrap gap-3">
          <a
            href="/#lead-form"
            class="inline-block font-(family-name:--font-headline) font-bold text-[17px] uppercase tracking-wide py-[15px] px-9 rounded-lg bg-gradient-to-br from-amber to-amber-light text-white shadow-[0_4px_16px_var(--color-amber-glow)] transition-all duration-200 hover:translate-y-[-1px] hover:shadow-[0_6px_24px_var(--color-amber-glow)]"
          >
            {defaults.mid_cta.button_text}
          </a>
          <a
            href={`tel:${config.company.phone_raw}`}
            class="inline-flex items-center gap-2 py-[15px] px-7 text-base font-semibold text-dark border-2 border-gray-200 rounded-lg transition-all duration-200 hover:border-green hover:text-green"
          >
            Call {config.company.phone}
          </a>
        </div>
      </div>
    </section>

    <!-- Related content -->
    <section class="py-12">
      <div class="wrap max-w-[740px]">
        <!-- Related posts -->
        {otherPosts.length > 0 && (
          <div class="mb-10">
            <h3 class="font-(family-name:--font-headline) font-bold text-[15px] uppercase text-gray-400 tracking-[0.08em] mb-4">More Articles</h3>
            <div class="grid grid-cols-2 gap-4 max-sm:grid-cols-1">
              {otherPosts.map((rp) => (
                <a href={`/blog/${rp.slug}`} class="block p-5 border border-gray-100 rounded-[10px] bg-white shadow-[0_1px_3px_rgba(0,0,0,0.06)] transition-all duration-200 hover:border-green hover:shadow-[0_8px_24px_rgba(0,0,0,0.08)] hover:translate-y-[-2px]">
                  <h4 class="font-(family-name:--font-headline) font-bold text-[14px] uppercase text-dark mb-1.5 leading-tight">{rp.title}</h4>
                  <p class="text-[12px] text-gray-400">{formatDate(rp.date)}</p>
                </a>
              ))}
            </div>
          </div>
        )}

        <!-- Related situation pages -->
        <div>
          <h3 class="font-(family-name:--font-headline) font-bold text-[15px] uppercase text-gray-400 tracking-[0.08em] mb-4">Related Pages</h3>
          <div class="flex flex-wrap gap-x-5 gap-y-2 text-[15px]">
            {linkedSituations.map((s) => (
              <a href={`/situations/${s.slug}`} class="text-green font-semibold underline hover:text-green-dark transition-colors">{s.title}</a>
            ))}
            <a href="/how-it-works" class="text-green font-semibold underline hover:text-green-dark transition-colors">How It Works</a>
            <a href="/#lead-form" class="text-green font-semibold underline hover:text-green-dark transition-colors">Get Your Cash Offer</a>
          </div>
        </div>
      </div>
    </section>
  </main>

  <FinalCTA />
  <Footer />
</BaseLayout>
